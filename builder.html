<html>
 <head>
  <title>DDEX1-4 Catacombs Map</title>
  <style>
    * { padding: 0; margin: 0; }
    .map { position: relative; padding: 0; spacing: 0; margin: 0 }
    #image { padding: 0; spacing: 0; margin: 0 }
    .sub-map { position: absolute; left: 0; top: 0; z-index: 5 }
    .black { position: absolute; left: 0; top: 0; background-color: black; z-index: 10 }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>
  /*!
   * jQuery clip-path-polygon Plugin v0.1.3 (2013-08-31)
   * jQuery plugin that makes easy to use clip-path on whatever tag under different browsers
   * https://github.com/andrusieczko/clip-path-polygon
   * 
   * Copyright 2013 Karol Andrusieczko
   * Released under MIT license
   */
 
   var jQuery = jQuery || (require && require('jquery'));
  (function($) {

    var ClipPath = function(jQuery, $el, points, options) {
      this.$ = jQuery;
      this.$el = $el;
      this.points = points;

      this.processOptions(options);
    };

    if (typeof exports !== 'undefined') {
      if (typeof module !== 'undefined' && module.exports) {
        exports = module.exports = ClipPath;
      }
      exports.ClipPath = ClipPath;
    } else {
      var globalVariable = window || root;
      globalVariable.ClipPath = ClipPath;
    }

    ClipPath.prototype = {

      $: null,
      $el: null,
      points: null,

      isForWebkit: true,
      isForSvg: true,
      svgDefId: 'clipPathPolygonGenId',

      create: function() {
        this._createClipPath(this.points);
      },

      _createClipPath: function(points) {
        this._createSvgDefs();
        if (this.isForWebkit) {
          this._createWebkitClipPath(points);
        }
        if (this.isForSvg) {
          this._createSvgBasedClipPath(points);
        }
      },

      _createWebkitClipPath: function(points) {
        var clipPath = "polygon(" + this._translatePoints(points, true) + ")";
        this.$el.css('-webkit-clip-path', clipPath);
      },

      _createSvgBasedClipPath: function(points) {
        this.$('#' + this.svgDefId + '').find('polygon').attr('points', this._translatePoints(points, false));
        this.$el.css('clip-path', 'url(#' + this.svgDefId + ')');
      },


      _translatePoints: function(points, withPxs) {
        var result = [];
        for (var i in points) {
          var x = this._handlePxs(points[i][0], withPxs);
          var y = this._handlePxs(points[i][1], withPxs);
          result.push(x + ' ' + y);
        }
        return result.join(', ');
      },

      _handlePxs: function(number, withPxs) {
        if (number === 0 || !withPxs) {
          return number;
        }
        return number + "px";
      },

      _createSvgElement: function(elementName) {
        return this.$(document.createElementNS('http://www.w3.org/2000/svg', elementName));
      },

      _createSvgDefs: function() {
        if (this.$('#' + this.svgDefId + '').size() === 0) {
          var $svg = this._createSvgElement('svg').attr('width', 0).attr('height', 0);
          var $defs = this._createSvgElement('defs');
          $svg.append($defs);
          var $clippath = this._createSvgElement('clipPath').attr('id', this.svgDefId);
          $defs.append($clippath);
          var $polygon = this._createSvgElement('polygon');
          $clippath.append($polygon);
          this.$('body').append($svg);
        }
      },

      processOptions: function(options) {
        this.isForWebkit = (options && options.isForWebkit) || this.isForWebkit;
        this.isForSvg = (options && options.isForSvg) || this.isForSvg;
        this.svgDefId = (options && options.svgDefId) || this.svgDefId;
      }
    };

    $.fn.clipPath = function(points, options) {
      return this.each(function() {
        var $el = $(this);
        var clipPath = new ClipPath($, $el, points, options);
        clipPath.create();
      });
    };

  }).call(this, jQuery);
  </script>
  <script>
   var imageElementId = 'image';
   function IsPercent(val) {
     var ret = ("" + val).substring(val.length - 1) == '%';
     return ret;
   }
   function PercentVal(val) {
     console.log("Converting : " + val);
     return parseFloat(val.substring(0, val.length - 1)) / 100.0;
   }
   function CoerceCoords(coords) {
     var ret = [];
     var width = $('#' + imageElementId).width();
     var height = $('#' + imageElementId).height();

     for (var i = 0; i < coords.length; ++i) {
       if (coords[i].length != 2) {
         alert('Your shit be broken');
       }
       var indv = [(IsPercent(coords[i][0]) ? 
                    PercentVal(coords[i][0]) * width : coords[i][0]),
                   (IsPercent(coords[i][1]) ?
                    PercentVal(coords[i][1]) * height : coords[i][1])];
       ret[i] = indv;
     }
     console.log(ret);
     return ret;
   }

   var boxid = 1;
   function AddBox(coords, uncover) {
     var parent = $('#map-container');
     console.log(parent.attr('id'));
     var name = 'blackout-' + boxid++;
     var child = $('<div id="'  + name + '" />');
     child.addClass('black');
     child.width($("#" + imageElementId).width());
     child.height($("#" + imageElementId).height());
     console.log(child.attr('id'));
     coords = CoerceCoords(coords);
     child.clipPath(coords);
     child.click(function() {
       $(this).fadeToggle();
     });
     var map_child = $('<img src="' + $("#" + imageElementId).attr("src") + '" />');
     map_child.addClass('sub-map');
     map_child.clipPath(coords);
     parent.append(map_child);
     parent.append(child);
     if (uncover) {
       child.click();
     }
   }
   function Square(corners) {
     return [[corners[0][0], corners[0][1]], [corners[0][0], corners[1][1]],
             [corners[1][0], corners[1][1]], [corners[1][0], corners[0][1]]];
   }
   $(function() {
     $("#image").click(function(e) {
       $("#clicks").append("<span>[" + e.clientX + ", " + e.clientY + "], </span>");

     });
   });
  </script>
 </head>
 <body style="background: blue">
  <div class='map' id='map-container'>
   <img id='image' src='ddex1-4 catacombs cropped.png' />
  </div>
  <div id='clicks'></id>
 </body>
</html>
